openapi: 3.1.0
info:
  title: Max's Attunement Assistant API
  description: Unified context API for Canvas LMS, Google Calendar, and weekly reflection management.
  version: 1.0.0

servers:
  - url: https://max-attunement-api.onrender.com
    description: Production server

security:
  - ApiKeyAuth: []

paths:
  /context:
    post:
      operationId: fetchMaxContext
      summary: Get unified context
      description: Returns assignments, calendar events, course performance, and recent graded items.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContextRequest"
      responses:
        "200":
          description: Unified context response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContextResponse"
        "403":
          $ref: "#/components/responses/Forbidden"

  /reflections/save:
    post:
      operationId: saveWeeklyReflection
      summary: Save a weekly reflection
      description: Appends a new reflection entry to the JSONL file in Google Drive.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SaveReflectionRequest"
      responses:
        "200":
          description: Reflection saved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SaveReflectionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /reflections/recent:
    post:
      operationId: getRecentReflections
      summary: Get recent reflections
      description: Returns the most recent N reflections, newest first.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecentReflectionsRequest"
      responses:
        "200":
          description: Recent reflections
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecentReflectionsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /reflections/cleanup:
    post:
      operationId: cleanupReflections
      summary: Cleanup duplicate reflections
      description: Removes duplicate reflections and adds a maintenance record.
      x-openai-isConsequential: false
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CleanupReflectionsRequest"
      responses:
        "200":
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CleanupReflectionsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /syllabus:
    get:
      operationId: getAllSyllabi
      summary: Get all course syllabi
      description: Returns all syllabi with grade weights, policies, and full content.
      x-openai-isConsequential: false
      responses:
        "200":
          description: List of all syllabi
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyllabusListResponse"
        "403":
          $ref: "#/components/responses/Forbidden"

  /syllabus/weights:
    get:
      operationId: getGradeWeights
      summary: Get grade weight summary for all courses
      description: Returns a lightweight summary of grade weights for all courses.
      x-openai-isConsequential: false
      responses:
        "200":
          description: Grade weight summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  weights:
                    type: array
                    items:
                      $ref: "#/components/schemas/GradeWeightSummary"
        "403":
          $ref: "#/components/responses/Forbidden"

  /syllabus/{course}:
    get:
      operationId: getSyllabus
      summary: Get a specific syllabus
      description: Returns syllabus for a course by slug or name (e.g., "latin-iii", "math", "english").
      x-openai-isConsequential: false
      parameters:
        - name: course
          in: path
          required: true
          schema:
            type: string
          description: Course slug or name (e.g., "latin-iii", "algebra", "history")
      responses:
        "200":
          description: Syllabus for the course
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyllabusResponse"
        "404":
          description: Course not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error: { type: string }
                  message: { type: string }
                  availableCourses:
                    type: array
                    items: { type: string }
        "403":
          $ref: "#/components/responses/Forbidden"

  /syllabus/match:
    post:
      operationId: matchSyllabus
      summary: Match a Canvas course name to a syllabus
      description: Given a Canvas course name, finds the matching syllabus.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [courseName]
              properties:
                courseName:
                  type: string
                  description: Canvas course name to match
      responses:
        "200":
          description: Match result
          content:
            application/json:
              schema:
                type: object
                properties:
                  matched: { type: boolean }
                  courseName: { type: string }
                  syllabus:
                    $ref: "#/components/schemas/Syllabus"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /syllabus/impact:
    post:
      operationId: calculateGradeImpact
      summary: Calculate grade impact for an assignment
      description: Given a course, category, and score, calculates the impact on overall grade.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GradeImpactRequest"
      responses:
        "200":
          description: Grade impact analysis
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GradeImpactResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /course/pages:
    post:
      operationId: listCoursePages
      summary: List all pages in a course
      description: Returns all Canvas pages for a course. Use this to find agendas, study guides, and other resources.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [courseId, student]
              properties:
                courseId:
                  type: integer
                  description: Canvas course ID
                student:
                  type: string
                  description: Student name (max or lev)
      responses:
        "200":
          description: List of pages
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CoursePagesResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /course/page:
    post:
      operationId: getPageContent
      summary: Get a specific page's content
      description: Fetches the full HTML content of a Canvas page.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [courseId, pageUrl, student]
              properties:
                courseId:
                  type: integer
                  description: Canvas course ID
                pageUrl:
                  type: string
                  description: Page URL slug (from /course/pages response)
                student:
                  type: string
                  description: Student name (max or lev)
      responses:
        "200":
          description: Page content
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageContentResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /course/materials:
    post:
      operationId: getCourseMaterials
      summary: Get all materials for a course
      description: Returns pages, module items, and external links. Optionally fetches linked Google Docs content.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [courseId, student]
              properties:
                courseId:
                  type: integer
                  description: Canvas course ID
                student:
                  type: string
                  description: Student name (max or lev)
                search:
                  type: string
                  description: Optional search term to filter materials
                includeContent:
                  type: boolean
                  description: Include full page content (default false)
                fetchGoogleDocs:
                  type: boolean
                  description: Fetch content from linked Google Docs (default true)
      responses:
        "200":
          description: Course materials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CourseMaterialsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /course/study-guide:
    post:
      operationId: findStudyGuide
      summary: Find study guide materials
      description: Searches for study guide, review, or test prep materials in a course.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [courseId, student]
              properties:
                courseId:
                  type: integer
                  description: Canvas course ID
                student:
                  type: string
                  description: Student name (max or lev)
                searchTerms:
                  type: array
                  items:
                    type: string
                  description: Custom search terms (default ["study guide", "review", "test prep"])
      responses:
        "200":
          description: Study guide materials found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StudyGuideResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  responses:
    Forbidden:
      description: Forbidden (missing or invalid API key)
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "Forbidden" }
              message: { type: string, example: "Missing or invalid X-API-Key header" }
    BadRequest:
      description: Bad request (validation error)
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "BadRequest" }
              message: { type: string, example: "Invalid request body" }

  schemas:
    ContextRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
          description: The parent/Max request in natural language.
        who:
          type: string
          description: Who is asking (Jud/Jules/Max).
        student:
          type: string
          description: Student name (Max).

    Assignment:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        courseId: { type: integer }
        courseName: { type: string }
        dueAt:
          type: string
          nullable: true
          description: ISO timestamp (may be null).
        due:
          type: string
          nullable: true
          description: Human-friendly due date string (time-stripped if you chose date-only).
        points:
          type: number
          nullable: true
        status:
          type: string
          nullable: true
        desc:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
          description: Path to assignment (e.g., /courses/123/assignments/456). Combine with canvasBaseUrl for full link.

    CalendarEvent:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        start:
          type: string
          nullable: true
        end:
          type: string
          nullable: true
        location:
          type: string
          nullable: true
        source:
          type: string
          description: e.g. google_calendar
        url:
          type: string
          nullable: true

    CoursePerformance:
      type: object
      properties:
        courseId: { type: integer }
        courseName: { type: string }
        currentScore:
          type: number
          nullable: true
        currentGrade:
          type: string
          nullable: true
        finalScore:
          type: number
          nullable: true
        finalGrade:
          type: string
          nullable: true

    RecentGradedItem:
      type: object
      properties:
        assignmentId: { type: integer }
        title: { type: string }
        score:
          type: number
          nullable: true
        pointsPossible:
          type: number
          nullable: true
        gradedAt:
          type: string
          nullable: true
        submittedAt:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
          description: Path to assignment (e.g., /courses/123/assignments/456). Combine with canvasBaseUrl for full link.

    RecentPerformance:
      type: object
      properties:
        courseId: { type: integer }
        courseName: { type: string }
        recentGraded:
          type: array
          items:
            $ref: "#/components/schemas/RecentGradedItem"

    Summary:
      type: object
      properties:
        courses:
          type: array
          items: { type: string }
        dueSoon:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              name: { type: string }
              courseName: { type: string }
              dueAt: { type: string, nullable: true }
              due: { type: string, nullable: true }
        assignmentCount: { type: integer }
        eventCount: { type: integer }

    ContextResponse:
      type: object
      properties:
        canvasBaseUrl:
          type: string
          description: Base URL for Canvas (e.g., https://waterfordschool.instructure.com). Combine with assignment url paths to form full links.
        assignments:
          type: array
          items: { $ref: "#/components/schemas/Assignment" }
        events:
          type: array
          items: { $ref: "#/components/schemas/CalendarEvent" }
        summary:
          $ref: "#/components/schemas/Summary"
        coursePerformance:
          type: array
          items: { $ref: "#/components/schemas/CoursePerformance" }
        recentPerformance:
          type: array
          items: { $ref: "#/components/schemas/RecentPerformance" }

    SaveReflectionRequest:
      type: object
      required: [who, text]
      properties:
        who:
          type: string
          enum: [Jud, Jules, Max]
        text:
          type: string
        threads:
          type: array
          items: { type: string }
          default: []

    SaveReflectionResponse:
      type: object
      properties:
        ok: { type: boolean }
        fileId: { type: string }
        fileName: { type: string }
        appendedAt: { type: string }

    RecentReflectionsRequest:
      type: object
      properties:
        n:
          type: integer
          default: 5
          description: Number of reflections to return.

    RecentReflection:
      type: object
      properties:
        type: { type: string }
        createdAt: { type: string }
        who: { type: string }
        text: { type: string }
        threads:
          type: array
          items: { type: string }

    RecentReflectionsResponse:
      type: object
      properties:
        count: { type: integer }
        reflections:
          type: array
          items: { $ref: "#/components/schemas/RecentReflection" }

    CleanupReflectionsRequest:
      type: object
      properties:
        dryRun:
          type: boolean
          default: false

    CleanupReflectionsResponse:
      type: object
      properties:
        ok: { type: boolean }
        removedCount: { type: integer }
        cleanedAt: { type: string }

    GradeWeight:
      type: object
      properties:
        category: { type: string }
        weight: { type: number }
        notes: { type: string, nullable: true }

    KeyPolicy:
      type: object
      properties:
        name: { type: string }
        description: { type: string }

    Syllabus:
      type: object
      properties:
        course: { type: string }
        slug: { type: string }
        teacher: { type: string, nullable: true }
        email: { type: string, nullable: true }
        room: { type: string, nullable: true }
        officeHours: { type: string, nullable: true }
        gradeWeights:
          type: array
          items:
            $ref: "#/components/schemas/GradeWeight"
        keyPolicies:
          type: array
          items:
            $ref: "#/components/schemas/KeyPolicy"
        rawMarkdown: { type: string }

    GradeWeightSummary:
      type: object
      properties:
        course: { type: string }
        slug: { type: string }
        weights:
          type: array
          items:
            $ref: "#/components/schemas/GradeWeight"

    SyllabusListResponse:
      type: object
      properties:
        syllabi:
          type: array
          items:
            $ref: "#/components/schemas/Syllabus"
        summary:
          type: array
          items:
            $ref: "#/components/schemas/GradeWeightSummary"

    SyllabusResponse:
      type: object
      properties:
        syllabus:
          $ref: "#/components/schemas/Syllabus"

    GradeImpactRequest:
      type: object
      required: [courseName, category, score, maxScore]
      properties:
        courseName:
          type: string
          description: Course name (e.g., "Latin III", "math")
        category:
          type: string
          description: Grade category (e.g., "quizzes", "tests", "homework")
        score:
          type: number
          description: Points earned
        maxScore:
          type: number
          description: Points possible
        currentGrade:
          type: number
          nullable: true
          description: Current overall grade percentage (optional)

    GradeImpactResponse:
      type: object
      properties:
        courseName: { type: string }
        percentScore: { type: number }
        categoryWeight: { type: number }
        categoryName: { type: string }
        maxPossibleImpact: { type: number }
        notes: { type: string, nullable: true }
        keyPolicies:
          type: array
          items:
            $ref: "#/components/schemas/KeyPolicy"
        interpretation: { type: string }

    CoursePage:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        urlSlug: { type: string }
        url: { type: string }
        updatedAt: { type: string }
        frontPage: { type: boolean }

    CoursePagesResponse:
      type: object
      properties:
        student: { type: string }
        courseId: { type: integer }
        pages:
          type: array
          items:
            $ref: "#/components/schemas/CoursePage"

    PageContentResponse:
      type: object
      properties:
        student: { type: string }
        courseId: { type: integer }
        page:
          type: object
          properties:
            id: { type: integer }
            title: { type: string }
            url: { type: string }
            content: { type: string }
            updatedAt: { type: string }

    GoogleDocContent:
      type: object
      properties:
        url: { type: string }
        type: { type: string, enum: [doc, spreadsheet, pdf, unknown] }
        content: { type: string, nullable: true }
        error: { type: string, nullable: true }

    MaterialItem:
      type: object
      properties:
        id: { type: string }
        type: { type: string, enum: [page, module_item, external_link] }
        title: { type: string }
        url: { type: string, nullable: true }
        content: { type: string, nullable: true }
        contentPreview: { type: string, nullable: true }
        googleDocs:
          type: array
          nullable: true
          items:
            $ref: "#/components/schemas/GoogleDocContent"

    CourseMaterialsResponse:
      type: object
      properties:
        student: { type: string }
        courseId: { type: integer }
        pages:
          type: array
          items:
            $ref: "#/components/schemas/MaterialItem"
        moduleItems:
          type: array
          items:
            $ref: "#/components/schemas/MaterialItem"
        externalLinks:
          type: array
          items:
            $ref: "#/components/schemas/MaterialItem"

    StudyGuideResponse:
      type: object
      properties:
        student: { type: string }
        courseId: { type: integer }
        studyGuides:
          type: array
          items:
            $ref: "#/components/schemas/MaterialItem"

