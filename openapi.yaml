openapi: 3.1.0
info:
  title: Max's Attunement Assistant API
  description: Unified context API for Canvas LMS, Google Calendar, and weekly reflection management.
  version: 1.0.0

servers:
  - url: https://max-attunement-api.onrender.com
    description: Production server

security:
  - ApiKeyAuth: []

paths:
  /context:
    post:
      operationId: fetchMaxContext
      summary: Get unified context
      description: Returns assignments, calendar events, course performance, and recent graded items.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContextRequest"
      responses:
        "200":
          description: Unified context response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContextResponse"
        "403":
          $ref: "#/components/responses/Forbidden"

  /reflections/save:
    post:
      operationId: saveWeeklyReflection
      summary: Save a weekly reflection
      description: Appends a new reflection entry to the JSONL file in Google Drive.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SaveReflectionRequest"
      responses:
        "200":
          description: Reflection saved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SaveReflectionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /reflections/recent:
    post:
      operationId: getRecentReflections
      summary: Get recent reflections
      description: Returns the most recent N reflections, newest first.
      x-openai-isConsequential: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecentReflectionsRequest"
      responses:
        "200":
          description: Recent reflections
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecentReflectionsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /reflections/cleanup:
    post:
      operationId: cleanupReflections
      summary: Cleanup duplicate reflections
      description: Removes duplicate reflections and adds a maintenance record.
      x-openai-isConsequential: false
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CleanupReflectionsRequest"
      responses:
        "200":
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CleanupReflectionsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  responses:
    Forbidden:
      description: Forbidden (missing or invalid API key)
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "Forbidden" }
              message: { type: string, example: "Missing or invalid X-API-Key header" }
    BadRequest:
      description: Bad request (validation error)
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "BadRequest" }
              message: { type: string, example: "Invalid request body" }

  schemas:
    ContextRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
          description: The parent/Max request in natural language.
        who:
          type: string
          description: Who is asking (Jud/Jules/Max).
        student:
          type: string
          description: Student name (Max).

    Assignment:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        courseId: { type: integer }
        courseName: { type: string }
        dueAt:
          type: string
          nullable: true
          description: ISO timestamp (may be null).
        due:
          type: string
          nullable: true
          description: Human-friendly due date string (time-stripped if you chose date-only).
        points:
          type: number
          nullable: true
        status:
          type: string
          nullable: true
        desc:
          type: string
          nullable: true
        url:
          type: string
          nullable: true

    CalendarEvent:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        start:
          type: string
          nullable: true
        end:
          type: string
          nullable: true
        location:
          type: string
          nullable: true
        source:
          type: string
          description: e.g. google_calendar
        url:
          type: string
          nullable: true

    CoursePerformance:
      type: object
      properties:
        courseId: { type: integer }
        courseName: { type: string }
        currentScore:
          type: number
          nullable: true
        currentGrade:
          type: string
          nullable: true
        finalScore:
          type: number
          nullable: true
        finalGrade:
          type: string
          nullable: true

    RecentGradedItem:
      type: object
      properties:
        assignmentId: { type: integer }
        title: { type: string }
        score:
          type: number
          nullable: true
        pointsPossible:
          type: number
          nullable: true
        gradedAt:
          type: string
          nullable: true
        submittedAt:
          type: string
          nullable: true
        url:
          type: string
          nullable: true

    RecentPerformance:
      type: object
      properties:
        courseId: { type: integer }
        courseName: { type: string }
        recentGraded:
          type: array
          items:
            $ref: "#/components/schemas/RecentGradedItem"

    Summary:
      type: object
      properties:
        courses:
          type: array
          items: { type: string }
        dueSoon:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              name: { type: string }
              courseName: { type: string }
              dueAt: { type: string, nullable: true }
              due: { type: string, nullable: true }
        assignmentCount: { type: integer }
        eventCount: { type: integer }

    ContextResponse:
      type: object
      properties:
        assignments:
          type: array
          items: { $ref: "#/components/schemas/Assignment" }
        events:
          type: array
          items: { $ref: "#/components/schemas/CalendarEvent" }
        summary:
          $ref: "#/components/schemas/Summary"
        coursePerformance:
          type: array
          items: { $ref: "#/components/schemas/CoursePerformance" }
        recentPerformance:
          type: array
          items: { $ref: "#/components/schemas/RecentPerformance" }

    SaveReflectionRequest:
      type: object
      required: [who, text]
      properties:
        who:
          type: string
          enum: [Jud, Jules, Max]
        text:
          type: string
        threads:
          type: array
          items: { type: string }
          default: []

    SaveReflectionResponse:
      type: object
      properties:
        ok: { type: boolean }
        fileId: { type: string }
        fileName: { type: string }
        appendedAt: { type: string }

    RecentReflectionsRequest:
      type: object
      properties:
        n:
          type: integer
          default: 5
          description: Number of reflections to return.

    RecentReflection:
      type: object
      properties:
        type: { type: string }
        createdAt: { type: string }
        who: { type: string }
        text: { type: string }
        threads:
          type: array
          items: { type: string }

    RecentReflectionsResponse:
      type: object
      properties:
        count: { type: integer }
        reflections:
          type: array
          items: { $ref: "#/components/schemas/RecentReflection" }

    CleanupReflectionsRequest:
      type: object
      properties:
        dryRun:
          type: boolean
          default: false

    CleanupReflectionsResponse:
      type: object
      properties:
        ok: { type: boolean }
        removedCount: { type: integer }
        cleanedAt: { type: string }

